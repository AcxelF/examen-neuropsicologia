<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen de Pr√°ctica de Neuropsicolog√≠a (JSON)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        h1 { color: #4CAF50; text-align: center; }
        .question {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fff;
            transition: border 0.3s;
        }
        .question p { font-weight: bold; margin-top: 0; color: #333; font-size: 1.05em; }
        .option { margin-bottom: 8px; }
        input[type="radio"] { margin-right: 8px; }
        button {
            display: block;
            width: 100%;
            padding: 12px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            margin-top: 30px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #results, #leaderboard-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            background-color: #e8f5e9;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }
        /* Estilos de retroalimentaci√≥n */
        .highlight-correct label { background-color: #d4edda; color: #155724; padding: 2px 5px; border-radius: 3px; }
        .highlight-incorrect label { background-color: #f8d7da; color: #721c24; padding: 2px 5px; border-radius: 3px; }
        .not-answered { border: 2px solid orange !important; }
        .explanation {
            margin-top: 10px;
            padding: 10px;
            border-left: 5px solid #2196F3;
            background-color: #e3f2fd;
            font-style: italic;
            font-size: 0.95em;
            color: #0d47a1;
            display: none;
        }
        /* Estilos del Leaderboard */
        #leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        #leaderboard-table th, #leaderboard-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        #leaderboard-table th { background-color: #f0f0f0; font-weight: bold; color: #333; }

        /* Ocultar resultados y leaderboard al inicio */
        #results, #leaderboard-section { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìù Examen de Pr√°ctica de Neuropsicolog√≠a</h1>
    <p>Selecciona la respuesta correcta para cada pregunta. Al finalizar, ver√°s tu puntaje y las explicaciones.</p>
    
    <div id="results">
        üéâ ¬°Examen Finalizado! üéâ<br>
        Tu puntaje es: <span id="score">0</span> de 82 aciertos.
    </div>

    <div id="leaderboard-section">
        <h2>üèÜ Tus Puntajes Recientes</h2>
        <p>Los puntajes se guardan solo en tu navegador.</p>
        <table id="leaderboard-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Aciertos</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <form id="quizForm">
        <div id="questions-container">
            <p>Cargando preguntas...</p>
        </div>
        
        <button type="button" onclick="calculateScore()">Finalizar Examen y Ver Resultados</button>
    </form>
</div>

<script>
    const STORAGE_KEY = 'neuropsy_leaderboard';
    let allQuestions = []; // Almacenar√° los datos del JSON
    
    // Funci√≥n para obtener los datos del JSON y renderizar el examen
    async function loadQuiz() {
        try {
            const response = await fetch('preguntas.json');
            if (!response.ok) {
                throw new Error('Error al cargar preguntas.json. Aseg√∫rate de que el archivo exista en la misma carpeta.');
            }
            allQuestions = await response.json();
            renderQuiz();
        } catch (error) {
            console.error('Fallo en la carga del examen:', error);
            document.getElementById('questions-container').innerHTML = '<p style="color:red;">Error: No se pudieron cargar las preguntas.</p>';
        }
    }

    // Funci√≥n para dibujar el HTML del examen
    function renderQuiz() {
        const container = document.getElementById('questions-container');
        container.innerHTML = ''; // Limpia el mensaje de carga
        let html = '';
        
        // Determinar l√≠mites para las secciones
        const sections = [
            { title: "Parte 1: Neuropsicolog√≠a y Atenci√≥n (Preguntas 1-20)", start: 1, end: 20 },
            { title: "Parte 2: Lenguaje, Praxias y Agnosias (Preguntas 21-42)", start: 21, end: 42 },
            { title: "Parte 3: Afasias, Historia y Plasticidad Profunda (Preguntas 43-82)", start: 43, end: 82 }
        ];

        let questionIndex = 0;
        
        sections.forEach(section => {
            html += `<h2>${section.title}</h2>`;
            
            for (let i = section.start; i <= section.end; i++) {
                const qData = allQuestions[questionIndex];
                if (!qData) break;

                const qNum = i;
                
                html += `
                    <div class="question" data-correct-answer="${qData.respuestaCorrecta}" data-explanation="${qData.explicacion}">
                        <p>${qNum}. ${qData.pregunta}</p>
                `;

                // Recorre las opciones (a, b, c, d)
                Object.keys(qData.opciones).forEach(optionKey => {
                    const optionText = qData.opciones[optionKey];
                    html += `
                        <div class="option" data-value="${optionKey}">
                            <input type="radio" id="q${qNum}${optionKey}" name="q${qNum}" value="${optionKey}">
                            <label for="q${qNum}${optionKey}">${optionKey.toUpperCase()}. ${optionText}</label>
                        </div>
                    `;
                });

                html += `
                        <div class="explanation"></div>
                    </div>
                `;
                questionIndex++;
            }
        });

        container.innerHTML = html;
    }

    // =======================================================
    // FUNCI√ìN PRINCIPAL: CALCULAR PUNTAJE Y MOSTRAR RETROALIMENTACI√ìN
    // =======================================================
    function calculateScore() {
        const questions = document.querySelectorAll('.question');
        const totalQuestions = allQuestions.length;
        let score = 0;

        // 1. Recorre y califica las preguntas
        questions.forEach((question, index) => {
            const questionNumber = index + 1;
            const correctAnswer = question.getAttribute('data-correct-answer');
            const explanationText = question.getAttribute('data-explanation');
            const questionName = `q${questionNumber}`; 
            const selectedOptionInput = document.querySelector(`input[name="${questionName}"]:checked`);
            const options = question.querySelectorAll('.option');
            let explanationDiv = question.querySelector('.explanation');

            // Limpiar estilos anteriores
            question.classList.remove('not-answered');
            if (explanationDiv) explanationDiv.style.display = 'none';

            // Limpia los estilos de feedback anteriores
            options.forEach(opt => {
                opt.classList.remove('highlight-correct', 'highlight-incorrect');
                const feedbackSpan = opt.querySelector('.feedback');
                if (feedbackSpan) { feedbackSpan.remove(); }
                opt.querySelector('label').style.backgroundColor = ''; 
                opt.querySelector('label').style.color = '';
            });

            // 2. Procesa la respuesta y aplica sombreado
            let isAnswered = false;
            if (selectedOptionInput) {
                isAnswered = true;
                const userAnswer = selectedOptionInput.value;
                const selectedOptionDiv = selectedOptionInput.closest('.option');

                if (userAnswer === correctAnswer) {
                    score++;
                    selectedOptionDiv.classList.add('highlight-correct');
                } else {
                    selectedOptionDiv.classList.add('highlight-incorrect');
                }
            } else {
                 question.classList.add('not-answered');
            }

            // 3. Muestra la retroalimentaci√≥n y la explicaci√≥n
            options.forEach(opt => {
                const optionValue = opt.getAttribute('data-value');
                let feedbackSpan = opt.querySelector('.feedback');
                
                if (!feedbackSpan) {
                    feedbackSpan = document.createElement('span');
                    feedbackSpan.classList.add('feedback');
                    opt.querySelector('label').appendChild(feedbackSpan);
                }

                if (optionValue === correctAnswer) {
                    // Es la respuesta correcta
                    feedbackSpan.innerHTML = (isAnswered && selectedOptionInput.value === correctAnswer) ? ' üíö ¬°Correcto!' : ' üíö (Correcta)';
                    opt.querySelector('label').style.backgroundColor = '#d4edda';
                    opt.querySelector('label').style.color = '#155724';
                    
                    // Muestra la explicaci√≥n (solo en la correcta)
                    if (explanationDiv && explanationText) {
                        explanationDiv.innerHTML = '<strong>Explicaci√≥n:</strong> ' + explanationText;
                        explanationDiv.style.display = 'block';
                    }

                } else if (isAnswered && selectedOptionInput.value === optionValue) {
                    // Muestra la respuesta INCORRECTA que marc√≥ el usuario
                    feedbackSpan.innerHTML = ' ‚ùå Incorrecto';
                } else {
                    feedbackSpan.innerHTML = ''; // Limpia el feedback de las opciones irrelevantes
                }
            });
        });

        // 4. Muestra resultados finales y deshabilita botones
        document.getElementById('score').textContent = score;
        document.getElementById('results').style.display = 'block';
        document.querySelector('button').disabled = true;
        
        // 5. Gesti√≥n del Leaderboard (Local)
        saveScore(score, totalQuestions);
        displayLeaderboard();
        document.getElementById('leaderboard-section').style.display = 'block';
        
        window.scrollTo(0, 0); // Vuelve al inicio para ver los resultados
    }


    // =======================================================
    // FUNCIONES DEL LEADERBOARD (LOCALSTORAGE)
    // =======================================================
    function saveScore(score, total) {
        const scores = getScores();
        const now = new Date();
        const dateString = now.toLocaleDateString('es-ES', { 
            year: 'numeric', month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });

        scores.push({
            score: score,
            total: total,
            date: dateString,
            timestamp: now.getTime()
        });

        scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp);
        const topScores = scores.slice(0, 10);

        localStorage.setItem(STORAGE_KEY, JSON.stringify(topScores));
    }

    function getScores() {
        const json = localStorage.getItem(STORAGE_KEY);
        try {
            return json ? JSON.parse(json) : [];
        } catch (e) {
            console.error("Error al parsear scores de localStorage:", e);
            return [];
        }
    }

    function displayLeaderboard() {
        const scores = getScores();
        const tbody = document.getElementById('leaderboard-table').querySelector('tbody');
        tbody.innerHTML = ''; 

        if (scores.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">A√∫n no tienes puntajes. ¬°Haz el examen!</td></tr>';
            return;
        }
        
        scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp); 

        scores.forEach((item, index) => {
            const row = tbody.insertRow();
            
            const cellRank = row.insertCell();
            cellRank.textContent = index + 1;
            
            const cellScore = row.insertCell();
            cellScore.textContent = `${item.score} / ${item.total} aciertos`;
            
            const cellDate = row.insertCell();
            cellDate.textContent = item.date;
        });
    }

    // Inicializaci√≥n: Cargar el quiz al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', loadQuiz);
</script>

</body>
</html>