<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Pr√°ctica de Neuropsicolog√≠a</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="theme-toggle-container">
        <label class="switch" title="Cambiar Tema">
            <input type="checkbox" id="theme-switch">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="container">
        <h1><span class="glitch" data-text="üìù Panel de Pr√°ctica de Neuropsicolog√≠a">üìù Panel de Pr√°ctica de Neuropsicolog√≠a</span></h1>
        <p>Selecciona una categor√≠a para iniciar tu examen de pr√°ctica.</p>
        
        <div id="results">
            üéâ ¬°Examen Finalizado! üéâ<br>
            Tu puntaje es: <span id="score">0</span> de <span id="total-q-count">0</span> aciertos.
        </div>

        <div id="leaderboard-section">
            <h2>üèÜ Tus Puntajes Recientes</h2>
            <p>Los puntajes se guardan solo en tu navegador.</p>
            <button type="button" class="clear-button" onclick="confirmClearHistory()">Limpiar Historial</button>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Aciertos</th>
                        <th>Categor√≠a</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button type="button" class="start-button" onclick="showCategoryMenu()">Volver al Men√∫ de Categor√≠as</button>
        </div>
        
        <div id="category-menu">
            <h2>Seleccionar Categor√≠a de Estudio</h2>
            <div id="card-grid">
                <p>Cargando categor√≠as...</p>
            </div>
        </div>

        <div id="quiz-content">
            <form id="quiz-form-content">
                <h2 id="current-category-title"></h2>
                <div id="questions-container">
                    </div>
                
                <button type="button" id="finish-button" onclick="calculateScore()">Finalizar Examen y Ver Resultados</button>
            </form>
        </div>
    </div>

<script>
    const STORAGE_KEY = 'neuropsy_leaderboard';
    let allQuestionsData = []; 
    let activeQuestions = [];  
    let isQuizActive = false;

    // =======================================================
    // GESTI√ìN DEL TEMA (MODO CLARO/OSCURO)
    // =======================================================
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Cargar el tema guardado
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-switch').checked = savedTheme === 'dark';

        // 2. Escuchar el cambio del switch
        document.getElementById('theme-switch').addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        });
        
        // 3. Iniciar la carga del quiz
        loadQuizData();
    });
    
    // =======================================================
    // FUNCI√ìN DE INICIALIZACI√ìN Y CARGA DE DATOS
    // =======================================================
    async function loadQuizData() {
        try {
            const response = await fetch('preguntas.json');
            if (!response.ok) {
                // Si el archivo no se encuentra o hay un error de CORS (al ejecutar localmente)
                throw new Error('Error al cargar preguntas.json. (Aseg√∫rate de usar Firefox o Live Server)');
            }
            allQuestionsData = await response.json();
            showCategoryMenu();
            displayLeaderboard(); 
        } catch (error) {
            console.error('Fallo en la carga del examen:', error);
            document.getElementById('card-grid').innerHTML = '<p style="color:red; text-align:center;">Error: No se pudieron cargar las preguntas. Revisa la consola y el archivo JSON.</p>';
        }
    }

    // =======================================================
    // FUNCI√ìN 1: MOSTRAR EL MEN√ö DE CATEGOR√çAS
    // =======================================================
    function showCategoryMenu() {
        document.getElementById('quiz-content').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        
        document.getElementById('category-menu').style.display = 'block';
        document.getElementById('leaderboard-section').style.display = 'block'; 

        const menuContainer = document.getElementById('card-grid');
        let menuHtml = '';

        const categories = allQuestionsData.reduce((acc, q) => {
            const category = q.categoria || "Sin Categor√≠a";
            if (!acc[category]) {
                acc[category] = 0;
            }
            acc[category]++;
            return acc;
        }, {});

        Object.keys(categories).forEach(categoryName => {
            const escapedCategoryName = categoryName.replace(/'/g, "\\'");
            menuHtml += `
                <div class="category-card" onclick="startQuiz('${escapedCategoryName}')">
                    <strong>${categoryName}</strong>
                    <span>(${categories[categoryName]} preguntas)</span>
                    <button type="button" class="start-button">Iniciar Pr√°ctica</button>
                </div>
            `;
        });
        
        menuContainer.innerHTML = menuHtml;
        displayLeaderboard();
        isQuizActive = false;
        window.scrollTo(0, 0);
    }

    // =======================================================
    // FUNCI√ìN 2: INICIAR EL EXAMEN FILTRADO
    // =======================================================
    function startQuiz(category) {
        document.getElementById('category-menu').style.display = 'none';
        document.getElementById('leaderboard-section').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('quiz-content').style.display = 'block';
        
        isQuizActive = true;

        // 1. Filtrar las preguntas
        activeQuestions = allQuestionsData.filter(q => (q.categoria || "Sin Categor√≠a") === category);
        
        // 2. Actualizar el t√≠tulo y el contador
        document.getElementById('current-category-title').textContent = `Categor√≠a: ${category} (${activeQuestions.length} preguntas)`;
        document.getElementById('total-q-count').textContent = activeQuestions.length;
        
        // 3. Renderizar las preguntas filtradas
        const container = document.getElementById('questions-container');
        container.innerHTML = '';
        let html = '';
        
        activeQuestions.forEach((qData, index) => {
            const qNum = index + 1;

            html += `
                <div class="question" data-correct-answer="${qData.respuestaCorrecta}" data-explanation="${qData.explicacion.replace(/"/g, "'")}">
                    <p>${qNum}. ${qData.pregunta}</p>
            `;

            Object.keys(qData.opciones).forEach(optionKey => {
                const optionText = qData.opciones[optionKey];
                html += `
                    <div class="option" data-value="${optionKey}">
                        <input type="radio" id="q${qNum}${optionKey}" name="q${qNum}" value="${optionKey}">
                        <label for="q${qNum}${optionKey}">${optionKey.toUpperCase()}. ${optionText}</label>
                    </div>
                `;
            });

            html += `
                    <div class="explanation"></div>
                </div>
            `;
        });

        container.innerHTML = html;
        document.getElementById('finish-button').disabled = false;
        window.scrollTo(0, 0);
    }

    // =======================================================
    // FUNCI√ìN PRINCIPAL: CALCULAR PUNTAJE (Retrolimentaci√≥n)
    // =======================================================
    function calculateScore() {
        if (!isQuizActive) return;

        const questions = document.querySelectorAll('#questions-container .question');
        const totalQuestions = activeQuestions.length;
        let score = 0;
        
        document.getElementById('finish-button').disabled = true; 
        isQuizActive = false;

        // 1. Recorre y califica las preguntas
        questions.forEach((question, index) => {
            const questionNumber = index + 1;
            const correctAnswer = question.getAttribute('data-correct-answer');
            const explanationText = question.getAttribute('data-explanation');
            const questionName = `q${questionNumber}`; 
            const selectedOptionInput = document.querySelector(`input[name="${questionName}"]:checked`);
            const options = question.querySelectorAll('.option');
            let explanationDiv = question.querySelector('.explanation');

            question.classList.remove('not-answered');
            if (explanationDiv) explanationDiv.style.display = 'none';

            options.forEach(opt => {
                opt.classList.remove('highlight-correct', 'highlight-incorrect');
                const feedbackSpan = opt.querySelector('.feedback');
                if (feedbackSpan) { feedbackSpan.remove(); }
                opt.querySelector('label').style.backgroundColor = ''; 
                opt.querySelector('label').style.color = '';
                
                opt.querySelector('input[type="radio"]').disabled = true;
            });

            let isAnswered = false;
            if (selectedOptionInput) {
                isAnswered = true;
                const userAnswer = selectedOptionInput.value;
                const selectedOptionDiv = selectedOptionInput.closest('.option');

                if (userAnswer === correctAnswer) {
                    score++;
                    selectedOptionDiv.classList.add('highlight-correct');
                } else {
                    selectedOptionDiv.classList.add('highlight-incorrect');
                }
            } else {
                 question.classList.add('not-answered');
            }

            // 3. Muestra la retroalimentaci√≥n y la explicaci√≥n
            options.forEach(opt => {
                const optionValue = opt.getAttribute('data-value');
                let feedbackSpan = opt.querySelector('.feedback');
                
                if (!feedbackSpan) {
                    feedbackSpan = document.createElement('span');
                    feedbackSpan.classList.add('feedback');
                    opt.querySelector('label').appendChild(feedbackSpan);
                }

                if (optionValue === correctAnswer) {
                    feedbackSpan.innerHTML = (isAnswered && selectedOptionInput.value === correctAnswer) ? ' üíö ¬°Correcto!' : ' üíö (Correcta)';
                    opt.querySelector('label').classList.add('correct-answer-label'); 
                    
                    if (explanationDiv && explanationText) {
                        explanationDiv.innerHTML = '<strong>Explicaci√≥n:</strong> ' + explanationText;
                        explanationDiv.style.display = 'block';
                    }

                } else if (isAnswered && selectedOptionInput.value === optionValue) {
                    feedbackSpan.innerHTML = ' ‚ùå Incorrecto';
                } else {
                    feedbackSpan.innerHTML = '';
                }
            });
        });

        // 4. Muestra resultados finales y Leaderboard
        document.getElementById('score').textContent = score;
        document.getElementById('total-q-count').textContent = totalQuestions;
        
        document.getElementById('results').style.display = 'block';
        document.getElementById('leaderboard-section').style.display = 'block';
        
        saveScore(score, totalQuestions);
        displayLeaderboard();
        
        window.scrollTo(0, 0);
    }

    // =======================================================
    // FUNCIONES DE GESTI√ìN DEL HISTORIAL
    // =======================================================
    function confirmClearHistory() {
        const confirmation = confirm("¬øEst√°s seguro de que quieres borrar todo el historial de puntajes? Esta acci√≥n no se puede deshacer.");
        if (confirmation) {
            localStorage.removeItem(STORAGE_KEY);
            displayLeaderboard(); 
            alert("Historial de puntajes borrado correctamente.");
        }
    }

    function saveScore(score, total) {
        const scores = getScores();
        const now = new Date();
        const currentCategory = document.getElementById('current-category-title').textContent.replace('Categor√≠a: ', '').split(' (')[0]; 
        
        const dateString = now.toLocaleDateString('es-ES', { 
            year: 'numeric', month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });

        scores.push({
            score: score,
            total: total,
            date: dateString,
            category: currentCategory || 'Completo',
            timestamp: now.getTime()
        });

        scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp);
        const topScores = scores.slice(0, 10);

        localStorage.setItem(STORAGE_KEY, JSON.stringify(topScores));
    }

    function getScores() {
        const json = localStorage.getItem(STORAGE_KEY);
        try {
            return json ? JSON.parse(json) : [];
        } catch (e) {
            console.error("Error al parsear scores de localStorage:", e);
            return [];
        }
    }

    function displayLeaderboard() {
        const scores = getScores();
        const tbody = document.getElementById('leaderboard-table').querySelector('tbody');
        tbody.innerHTML = ''; 

        if (scores.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">A√∫n no tienes puntajes. ¬°Haz el examen!</td></tr>';
            return;
        }
        
        scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp); 

        scores.forEach((item, index) => {
            const row = tbody.insertRow();
            
            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = `${item.score} / ${item.total}`;
            row.insertCell().textContent = item.category || 'Completo';
            row.insertCell().textContent = item.date;
        });
    }
</script>

</body>
</html>
