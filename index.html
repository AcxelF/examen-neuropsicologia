<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Pr√°ctica de Neuropsicolog√≠a</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); }
        h1 { color: #4CAF50; text-align: center; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-top: 30px; color: #007bff; }
        
        /* Estilos espec√≠ficos del Men√∫ de Categor√≠as */
        #category-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }
        .category-card {
            background-color: #e8f5e9; /* Fondo claro para las tarjetas */
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #d4edda; /* Resaltar al pasar el rat√≥n */
        }
        .category-card strong {
            display: block;
            font-size: 1.2em;
            color: #155724;
            margin-bottom: 5px;
        }

        /* Estilos de Botones y Formulario de Examen */
        button.start-button {
            background-color: #4CAF50;
            margin-top: 10px;
        }
        button.start-button:hover {
            background-color: #45a049;
        }
        #quiz-content button { 
            margin-top: 30px; 
            background-color: #007bff; 
        }

        /* Estilos de preguntas, retroalimentaci√≥n y leaderboard (mantener los del c√≥digo anterior) */
        .question { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background-color: #fff; transition: border 0.3s; }
        .question p { font-weight: bold; margin-top: 0; color: #333; font-size: 1.05em; }
        .option { margin-bottom: 8px; }
        input[type="radio"] { margin-right: 8px; }
        
        .highlight-correct label { background-color: #d4edda; color: #155724; padding: 2px 5px; border-radius: 3px; }
        .highlight-incorrect label { background-color: #f8d7da; color: #721c24; padding: 2px 5px; border-radius: 3px; }
        .explanation { margin-top: 10px; padding: 10px; border-left: 5px solid #2196F3; background-color: #e3f2fd; font-style: italic; font-size: 0.95em; color: #0d47a1; display: none; }
        #leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        #leaderboard-table th, #leaderboard-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        #leaderboard-table th { background-color: #f0f0f0; font-weight: bold; color: #333; }

        /* Ocultar secciones din√°micas al inicio */
        #results, #leaderboard-section, #quiz-content { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìù Panel de Pr√°ctica de Neuropsicolog√≠a</h1>
    <p>Selecciona una categor√≠a para iniciar tu examen de pr√°ctica.</p>
    
    <div id="results">
        üéâ ¬°Examen Finalizado! üéâ<br>
        Tu puntaje es: <span id="score">0</span> de <span id="total-q-count">82</span> aciertos.
    </div>

    <div id="leaderboard-section">
        <h2>üèÜ Tus Puntajes Recientes</h2>
        <p>Los puntajes se guardan solo en tu navegador.</p>
        <table id="leaderboard-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Aciertos</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button type="button" class="start-button" onclick="showCategoryMenu()">Volver al Men√∫ Principal</button>
    </div>
    
    <div id="category-menu">
        <h2>Seleccionar Categor√≠a de Estudio</h2>
        <p>Cargando categor√≠as...</p>
    </div>

    <form id="quiz-content">
        <h2 id="current-category-title"></h2>
        <div id="questions-container">
            </div>
        
        <button type="button" onclick="calculateScore()">Finalizar Examen y Ver Resultados</button>
    </form>
</div>

<script>
    const STORAGE_KEY = 'neuropsy_leaderboard';
    let allQuestionsData = []; // Almacenar√° los datos originales del JSON
    let activeQuestions = [];  // Almacenar√° las preguntas de la categor√≠a seleccionada

    // =======================================================
    // FUNCI√ìN DE INICIALIZACI√ìN Y CARGA DE DATOS
    // =======================================================
    async function loadQuizData() {
        try {
            const response = await fetch('preguntas.json');
            if (!response.ok) {
                throw new Error('Error al cargar preguntas.json. Aseg√∫rate de que el archivo exista.');
            }
            allQuestionsData = await response.json();
            showCategoryMenu();
            displayLeaderboard(); // Carga el leaderboard al inicio
        } catch (error) {
            console.error('Fallo en la carga del examen:', error);
            document.getElementById('category-menu').innerHTML = '<p style="color:red; text-align:center;">Error: No se pudieron cargar las preguntas. Revisa la consola y el archivo JSON.</p>';
        }
    }

    // =======================================================
    // FUNCI√ìN 1: MOSTRAR EL MEN√ö DE CATEGOR√çAS
    // =======================================================
    function showCategoryMenu() {
        document.getElementById('quiz-content').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('category-menu').style.display = 'block';
        document.getElementById('leaderboard-section').style.display = 'block'; // Muestra Leaderboard en el men√∫

        const menuContainer = document.getElementById('category-menu');
        let menuHtml = '<h2>Seleccionar Categor√≠a de Estudio</h2><div id="card-grid">';

        // Agrupa las preguntas por categor√≠a para contarlas
        const categories = allQuestionsData.reduce((acc, q) => {
            const category = q.categoria || "Sin Categor√≠a";
            if (!acc[category]) {
                acc[category] = 0;
            }
            acc[category]++;
            return acc;
        }, {});

        // Crea una tarjeta por cada categor√≠a
        Object.keys(categories).forEach(categoryName => {
            menuHtml += `
                <div class="category-card" onclick="startQuiz('${categoryName.replace(/'/g, "\\'")}')">
                    <strong>${categoryName}</strong>
                    <span>(${categories[categoryName]} preguntas)</span>
                    <button type="button" class="start-button">Iniciar Pr√°ctica</button>
                </div>
            `;
        });
        
        menuHtml += '</div>';
        menuContainer.innerHTML = menuHtml;
    }

    // =======================================================
    // FUNCI√ìN 2: INICIAR EL EXAMEN FILTRADO
    // =======================================================
    function startQuiz(category) {
        document.getElementById('category-menu').style.display = 'none';
        document.getElementById('leaderboard-section').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('quiz-content').style.display = 'block';

        // 1. Filtrar las preguntas
        activeQuestions = allQuestionsData.filter(q => (q.categoria || "Sin Categor√≠a") === category);
        
        // 2. Actualizar el t√≠tulo y el contador
        document.getElementById('current-category-title').textContent = `Categor√≠a: ${category} (${activeQuestions.length} preguntas)`;
        document.getElementById('total-q-count').textContent = activeQuestions.length;
        
        // 3. Renderizar las preguntas filtradas
        const container = document.getElementById('questions-container');
        let html = '';
        
        activeQuestions.forEach((qData, index) => {
            const qNum = index + 1; // La numeraci√≥n comienza en 1 para la vista

            html += `
                <div class="question" data-correct-answer="${qData.respuestaCorrecta}" data-explanation="${qData.explicacion}">
                    <p>${qNum}. ${qData.pregunta}</p>
            `;

            // Recorre las opciones (a, b, c, d)
            Object.keys(qData.opciones).forEach(optionKey => {
                const optionText = qData.opciones[optionKey];
                html += `
                    <div class="option" data-value="${optionKey}">
                        <input type="radio" id="q${qNum}${optionKey}" name="q${qNum}" value="${optionKey}">
                        <label for="q${qNum}${optionKey}">${optionKey.toUpperCase()}. ${optionText}</label>
                    </div>
                `;
            });

            html += `
                    <div class="explanation"></div>
                </div>
            `;
        });

        container.innerHTML = html;
        document.querySelector('#quiz-content button').disabled = false;
        window.scrollTo(0, 0);
    }

    // =======================================================
    // FUNCI√ìN PRINCIPAL: CALCULAR PUNTAJE (Retrolimentaci√≥n)
    // =======================================================
    function calculateScore() {
        const questions = document.querySelectorAll('#questions-container .question');
        const totalQuestions = activeQuestions.length;
        let score = 0;

        // 1. Recorre y califica las preguntas
        questions.forEach((question, index) => {
            const questionNumber = index + 1;
            const correctAnswer = question.getAttribute('data-correct-answer');
            const explanationText = question.getAttribute('data-explanation');
            const questionName = `q${questionNumber}`; 
            const selectedOptionInput = document.querySelector(`input[name="${questionName}"]:checked`);
            const options = question.querySelectorAll('.option');
            let explanationDiv = question.querySelector('.explanation');

            // Limpia estilos anteriores
            question.classList.remove('not-answered');
            if (explanationDiv) explanationDiv.style.display = 'none';

            options.forEach(opt => {
                opt.classList.remove('highlight-correct', 'highlight-incorrect');
                const feedbackSpan = opt.querySelector('.feedback');
                if (feedbackSpan) { feedbackSpan.remove(); }
                opt.querySelector('label').style.backgroundColor = ''; 
                opt.querySelector('label').style.color = '';
            });

            let isAnswered = false;
            if (selectedOptionInput) {
                isAnswered = true;
                const userAnswer = selectedOptionInput.value;
                const selectedOptionDiv = selectedOptionInput.closest('.option');

                if (userAnswer === correctAnswer) {
                    score++;
                    selectedOptionDiv.classList.add('highlight-correct');
                } else {
                    selectedOptionDiv.classList.add('highlight-incorrect');
                }
            } else {
                 question.classList.add('not-answered');
            }

            // 3. Muestra la retroalimentaci√≥n y la explicaci√≥n
            options.forEach(opt => {
                const optionValue = opt.getAttribute('data-value');
                let feedbackSpan = opt.querySelector('.feedback');
                
                if (!feedbackSpan) {
                    feedbackSpan = document.createElement('span');
                    feedbackSpan.classList.add('feedback');
                    opt.querySelector('label').appendChild(feedbackSpan);
                }

                if (optionValue === correctAnswer) {
                    feedbackSpan.innerHTML = (isAnswered && selectedOptionInput.value === correctAnswer) ? ' üíö ¬°Correcto!' : ' üíö (Correcta)';
                    opt.querySelector('label').style.backgroundColor = '#d4edda';
                    opt.querySelector('label').style.color = '#155724';
                    
                    if (explanationDiv && explanationText) {
                        explanationDiv.innerHTML = '<strong>Explicaci√≥n:</strong> ' + explanationText;
                        explanationDiv.style.display = 'block';
                    }

                } else if (isAnswered && selectedOptionInput.value === optionValue) {
                    feedbackSpan.innerHTML = ' ‚ùå Incorrecto';
                } else {
                    feedbackSpan.innerHTML = '';
                }
            });
        });

        // 4. Mostrar resultados finales
        document.getElementById('score').textContent = score;
        document.getElementById('total-q-count').textContent = totalQuestions;
        document.getElementById('quiz-content').style.display = 'none';

        // Muestra los resultados, guarda el score y vuelve a mostrar el men√∫ de opciones
        document.getElementById('results').style.display = 'block';
        document.getElementById('leaderboard-section').style.display = 'block';
        
        saveScore(score, totalQuestions);
        displayLeaderboard();
        
        window.scrollTo(0, 0);
    }

    // =======================================================
    // FUNCIONES DEL LEADERBOARD (LOCALSTORAGE)
    // =======================================================
    function saveScore(score, total) {
        const scores = getScores();
        const now = new Date();
        // Muestra la categor√≠a en el leaderboard para saber qu√© se practic√≥
        const currentCategory = document.getElementById('current-category-title').textContent.replace('Categor√≠a: ', '').split(' (')[0]; 
        
        const dateString = now.toLocaleDateString('es-ES', { 
            year: 'numeric', month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });

        scores.push({
            score: score,
            total: total,
            date: dateString,
            category: currentCategory, // Guarda la categor√≠a
            timestamp: now.getTime()
        });

        scores.sort((a, b) => b.score - a.score);
        const topScores = scores.slice(0, 10);

        localStorage.setItem(STORAGE_KEY, JSON.stringify(topScores));
    }

    function getScores() {
        const json = localStorage.getItem(STORAGE_KEY);
        try {
            return json ? JSON.parse(json) : [];
        } catch (e) {
            console.error("Error al parsear scores de localStorage:", e);
            return [];
        }
    }

    function displayLeaderboard() {
        const scores = getScores();
        const tbody = document.getElementById('leaderboard-table').querySelector('tbody');
        tbody.innerHTML = ''; 

        if (scores.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">A√∫n no tienes puntajes. ¬°Haz el examen!</td></tr>';
            return;
        }
        
        scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp); 

        // Actualiza el encabezado de la tabla para incluir Categor√≠a
        document.getElementById('leaderboard-table').querySelector('thead tr').innerHTML = 
            '<th>#</th><th>Aciertos</th><th>Categor√≠a</th><th>Fecha</th>';

        scores.forEach((item, index) => {
            const row = tbody.insertRow();
            
            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = `${item.score} / ${item.total}`;
            row.insertCell().textContent = item.category || 'Completo'; // Muestra la categor√≠a
            row.insertCell().textContent = item.date;
        });
    }

    // Inicializaci√≥n: Cargar los datos al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', loadQuizData);
</script>

</body>
</html>
