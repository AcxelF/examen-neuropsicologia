<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Pr√°ctica de Neuropsicolog√≠a</title>
    <style>
        /* ================================================= */
        /* BASE Y TEMAS (MODO CLARO/OSCURO) */
        /* ================================================= */
        :root {
            --bg-color: #f4f4f4;
            --container-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --header-color: #4CAF50;
            --secondary-header-color: #007bff;
            --card-bg: #e8f5e9;
            --card-hover-bg: #d4edda;
            --explanation-bg: #e3f2fd;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #f0f0f0;
            --border-color: #444;
            --header-color: #69f0ae; /* Verde m√°s brillante */
            --secondary-header-color: #82b1ff; /* Azul m√°s brillante */
            --card-bg: #2d2d2d;
            --card-hover-bg: #3a3a3a;
            --explanation-bg: #2a3e50;
        }
        
        body { font-family: Arial, sans-serif; margin: 20px; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 900px; margin: auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); }
        h1 { color: var(--header-color); text-align: center; }
        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-top: 30px; color: var(--secondary-header-color); }
        
        /* Tema del Leaderboard y preguntas */
        .question { border: 1px solid var(--border-color); background-color: var(--container-bg); }
        .question p { color: var(--text-color); }
        #leaderboard-table th { background-color: var(--card-bg); color: var(--text-color); }
        #leaderboard-table td { border-bottom: 1px solid var(--border-color); }

        /* Estilos del Switch de Tema */
        #theme-toggle-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Estilos de Botones y Formulario de Examen */
        button { background-color: #007bff; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.3s; }
        #leaderboard-section .clear-button { background-color: #f44336; margin-top: 10px; padding: 8px 15px; width: auto; font-size: 14px; display: block; margin-left: auto; margin-right: auto; }
        #leaderboard-section .clear-button:hover { background-color: #d32f2f; }
        
        /* Resto de estilos */
        #card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .category-card { background-color: var(--card-bg); border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s; }
        .category-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); background-color: var(--card-hover-bg); }
        .category-card strong { color: var(--text-color); }
        .explanation { border-left: 5px solid var(--secondary-header-color); background-color: var(--explanation-bg); color: var(--text-color); }
        .highlight-correct label { background-color: #d4edda; color: #155724; }
        .highlight-incorrect label { background-color: #f8d7da; color: #721c24; }
        
        /* Excepci√≥n para modo oscuro en retroalimentaci√≥n */
        [data-theme="dark"] .highlight-correct label { background-color: #1b5e20; color: #a5d6a7; }
        [data-theme="dark"] .highlight-incorrect label { background-color: #b71c1c; color: #ffcdd2; }

        /* Ocultar secciones din√°micas al inicio */
        #results, #leaderboard-section, #quiz-content { display: none; }
    </style>
</head>
<body>

    <div id="theme-toggle-container" class="container">
        <label class="switch" title="Cambiar Tema">
            <input type="checkbox" id="theme-switch">
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="container">
        <h1>üìù Panel de Pr√°ctica de Neuropsicolog√≠a</h1>
        <p>Selecciona una categor√≠a para iniciar tu examen de pr√°ctica.</p>
        
        <div id="results">
            üéâ ¬°Examen Finalizado! üéâ<br>
            Tu puntaje es: <span id="score">0</span> de <span id="total-q-count">0</span> aciertos.
        </div>

        <div id="leaderboard-section">
            <h2>üèÜ Tus Puntajes Recientes</h2>
            <p>Los puntajes se guardan solo en tu navegador.</p>
            <button type="button" class="clear-button" onclick="confirmClearHistory()">Limpiar Historial</button>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Aciertos</th>
                        <th>Categor√≠a</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <button type="button" class="start-button" onclick="showCategoryMenu()">Volver al Men√∫ de Categor√≠as</button>
        </div>
        
        <div id="category-menu">
            <h2>Seleccionar Categor√≠a de Estudio</h2>
            <div id="card-grid">
                <p>Cargando categor√≠as...</p>
            </div>
        </div>

        <div id="quiz-content">
            <form id="quiz-form-content">
                <h2 id="current-category-title"></h2>
                <div id="questions-container">
                    </div>
                
                <button type="button" id="finish-button" onclick="calculateScore()">Finalizar Examen y Ver Resultados</button>
            </form>
        </div>
    </div>

<script>
    const STORAGE_KEY = 'neuropsy_leaderboard';
    let allQuestionsData = []; 
    let activeQuestions = [];  
    let isQuizActive = false;

    // =======================================================
    // GESTI√ìN DEL TEMA (MODO CLARO/OSCURO)
    // =======================================================
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Cargar el tema guardado
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-switch').checked = savedTheme === 'dark';

        // 2. Escuchar el cambio del switch
        document.getElementById('theme-switch').addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        });
        
        // 3. Iniciar la carga del quiz
        loadQuizData();
    });
    
    // =======================================================
    // FUNCI√ìN DE INICIALIZACI√ìN Y CARGA DE DATOS
    // =======================================================
    async function loadQuizData() {
        try {
            const response = await fetch('preguntas.json');
            if (!response.ok) {
                throw new Error('Error al cargar preguntas.json. Aseg√∫rate de que el archivo exista en la misma carpeta.');
            }
            allQuestionsData = await response.json();
            showCategoryMenu();
            displayLeaderboard();
        } catch (error) {
            console.error('Fallo en la carga del examen:', error);
            document.getElementById('category-menu').innerHTML = '<p style="color:red; text-align:center;">Error: No se pudieron cargar las preguntas. Revisa la consola y el archivo JSON.</p>';
        }
    }

    // =======================================================
    // FUNCI√ìN 1: MOSTRAR EL MEN√ö DE CATEGOR√çAS
    // =======================================================
    function showCategoryMenu() {
        // Limpia la vista de resultados
        document.getElementById('quiz-content').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        
        // Muestra el men√∫ principal
        document.getElementById('category-menu').style.display = 'block';
        document.getElementById('leaderboard-section').style.display = 'block'; 

        const menuContainer = document.getElementById('card-grid');
        let menuHtml = '';
        
        // El resto de la l√≥gica del men√∫ se mantiene igual:
        const categories = allQuestionsData.reduce((acc, q) => {
            const category = q.categoria || "Sin Categor√≠a";
            if (!acc[category]) {
                acc[category] = 0;
            }
            acc[category]++;
            return acc;
        }, {});

        Object.keys(categories).forEach(categoryName => {
            const escapedCategoryName = categoryName.replace(/'/g, "\\'");
            menuHtml += `
                <div class="category-card" onclick="startQuiz('${escapedCategoryName}')">
                    <strong>${categoryName}</strong>
                    <span>(${categories[categoryName]} preguntas)</span>
                    <button type="button" class="start-button">Iniciar Pr√°ctica</button>
                </div>
            `;
        });
        
        menuContainer.innerHTML = menuHtml;
        displayLeaderboard();
        isQuizActive = false;
        window.scrollTo(0, 0);
    }

    // =======================================================
    // FUNCI√ìN 2: INICIAR EL EXAMEN FILTRADO
    // =======================================================
    function startQuiz(category) {
        document.getElementById('category-menu').style.display = 'none';
        document.getElementById('leaderboard-section').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById('quiz-content').style.display = 'block';
        
        isQuizActive = true;

        // 1. Filtrar las preguntas
        activeQuestions = allQuestionsData.filter(q => (q.categoria || "Sin Categor√≠a") === category);
        
        // 2. Actualizar el t√≠tulo y el contador
        document.getElementById('current-category-title').textContent = `Categor√≠a: ${category} (${activeQuestions.length} preguntas)`;
        document.getElementById('total-q-count').textContent = activeQuestions.length;
        
        // 3. Renderizar las preguntas filtradas
        const container = document.getElementById('questions-container');
        container.innerHTML = '';
        let html = '';
        
        activeQuestions.forEach((qData, index) => {
            const qNum = index + 1; 

            html += `
                <div class="question" data-correct-answer="${qData.respuestaCorrecta}" data-explanation="${qData.explicacion.replace(/"/g, "'")}">
                    <p>${qNum}. ${qData.pregunta}</p>
            `;

            Object.keys(qData.opciones).forEach(optionKey => {
                const optionText = qData.opciones[optionKey];
                html += `
                    <div class="option" data-value="${optionKey}">
                        <input type="radio" id="q${qNum}${optionKey}" name="q${qNum}" value="${optionKey}">
                        <label for="q${qNum}${optionKey}">${optionKey.toUpperCase()}. ${optionText}</label>
                    </div>
                `;
            });

            html += `
                    <div class="explanation"></div>
                </div>
            `;
        });

        container.innerHTML = html;
        document.getElementById('finish-button').disabled = false;
        window.scrollTo(0, 0);
    }

    // =======================================================
    // FUNCI√ìN PRINCIPAL: CALCULAR PUNTAJE (Persistencia en vista de examen)
    // =======================================================
    function calculateScore() {
        if (!isQuizActive) return; // Evita doble c√°lculo

        const questions = document.querySelectorAll('#questions-container .question');
        const totalQuestions = activeQuestions.length;
        let score = 0;
        
        document.getElementById('finish-button').disabled = true; 
        isQuizActive = false; // Desactiva el quiz despu√©s de calcular

        // 1. Recorre y califica las preguntas
        questions.forEach((question, index) => {
            const questionNumber = index + 1;
            const correctAnswer = question.getAttribute('data-correct-answer');
            const explanationText = question.getAttribute('data-explanation');
            const questionName = `q${questionNumber}`; 
            const selectedOptionInput = document.querySelector(`input[name="${questionName}"]:checked`);
            const options = question.querySelectorAll('.option');
            let explanationDiv = question.querySelector('.explanation');

            question.classList.remove('not-answered');
            if (explanationDiv) explanationDiv.style.display = 'none';

            let isAnswered = false;
            if (selectedOptionInput) {
                isAnswered = true;
                const userAnswer = selectedOptionInput.value;
                const selectedOptionDiv = selectedOptionInput.closest('.option');

                if (userAnswer === correctAnswer) {
                    score++;
                    selectedOptionDiv.classList.add('highlight-correct');
                } else {
                    selectedOptionDiv.classList.add('highlight-incorrect');
                }
            } else {
                 question.classList.add('not-answered');
            }

            // 3. Muestra la retroalimentaci√≥n y la explicaci√≥n
            options.forEach(opt => {
                const optionValue = opt.getAttribute('data-value');
                let feedbackSpan = opt.querySelector('.feedback');
                
                if (!feedbackSpan) {
                    feedbackSpan = document.createElement('span');
                    feedbackSpan.classList.add('feedback');
                    opt.querySelector('label').appendChild(feedbackSpan);
                }
                
                // Deshabilita los radio buttons en la vista de resultados
                opt.querySelector('input[type="radio"]').disabled = true;

                if (optionValue === correctAnswer) {
                    feedbackSpan.innerHTML = (isAnswered && selectedOptionInput.value === correctAnswer) ? ' üíö ¬°Correcto!' : ' üíö (Correcta)';
                    opt.querySelector('label').style.backgroundColor = '#d4edda';
                    opt.querySelector('label').style.color = '#155724';
                    
                    if (explanationDiv && explanationText) {
                        explanationDiv.innerHTML = '<strong>Explicaci√≥n:</strong> ' + explanationText;
                        explanationDiv.style.display = 'block';
                    }

                } else if (isAnswered && selectedOptionInput.value === optionValue) {
                    feedbackSpan.innerHTML = ' ‚ùå Incorrecto';
                } else {
                    feedbackSpan.innerHTML = '';
                }
            });
        });

        // 4. Muestra resultados finales
        document.getElementById('score').textContent = score;
        document.getElementById('total-q-count').textContent = totalQuestions;
        
        document.getElementById('results').style.display = 'block';
        document.getElementById('leaderboard-section').style.display = 'block';
        
        saveScore(score, totalQuestions);
        displayLeaderboard();
        
        window.scrollTo(0, 0); // Vuelve al inicio para ver los resultados
    }

    // =======================================================
    // FUNCIONES DE GESTI√ìN DEL HISTORIAL (LEADERBOARD)
    // =======================================================
    
    // Funci√≥n de confirmaci√≥n para limpiar historial
    function confirmClearHistory() {
        const confirmation = confirm("¬øEst√°s seguro de que quieres borrar todo el historial de puntajes? Esta acci√≥n no se puede deshacer.");
        if (confirmation) {
            localStorage.removeItem(STORAGE_KEY);
            displayLeaderboard(); // Vuelve a dibujar la tabla vac√≠a
            alert("Historial de puntajes borrado correctamente.");
        }
    }

    function saveScore(score, total) {
        const scores = getScores();
        const now = new Date();
        const currentCategory = document.getElementById('current-category-title').textContent.replace('Categor√≠a: ', '').split(' (')[0]; 
        
        const dateString = now.toLocaleDateString('es-ES', { 
            year: 'numeric', month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit' 
        });

        scores.push({
            score: score,
            total: total,
            date: dateString,
            category: currentCategory || 'Completo',
            timestamp: now.getTime()
        });

        scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp);
        const topScores = scores.slice(0, 10);

        localStorage.setItem(STORAGE_KEY, JSON.stringify(topScores));
    }

    function getScores() {
        const json = localStorage.getItem(STORAGE_KEY);
        try {
            return json ? JSON.parse(json) : [];
        } catch (e) {
            console.error("Error al parsear scores de localStorage:", e);
            return [];
        }
    }

    function displayLeaderboard() {
        const scores = getScores();
        const tbody = document.getElementById('leaderboard-table').querySelector('tbody');
        tbody.innerHTML = ''; 

        if (scores.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">A√∫n no tienes puntajes. ¬°Haz el examen!</td></tr>';
            return;
        }
        
        scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp); 

        scores.forEach((item, index) => {
            const row = tbody.insertRow();
            
            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = `${item.score} / ${item.total}`;
            row.insertCell().textContent = item.category || 'Completo';
            row.insertCell().textContent = item.date;
        });
    }

    // Inicializaci√≥n: Cargar los datos al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', loadQuizData);
</script>

</body>
</html>
